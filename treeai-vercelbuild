#!/bin/bash

# TreeAI Vercel Build Script
# Builds and prepares the TreeShop AI PWA for deployment

set -e

echo "🌳 TreeAI Vercel Build Script Starting..."
echo "============================================"

# Colors for output
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# Function to print colored output
print_status() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

print_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# Check if we're in the right directory
if [ ! -f "package.json" ]; then
    print_error "package.json not found. Are you in the treeshop-pwa directory?"
    exit 1
fi

print_status "Checking project dependencies..."

# Install dependencies if node_modules doesn't exist
if [ ! -d "node_modules" ]; then
    print_status "Installing npm dependencies..."
    npm install
    print_success "Dependencies installed"
else
    print_success "Dependencies already installed"
fi

# Check if Convex is configured
if [ ! -f ".env.local" ]; then
    print_warning ".env.local not found. Creating template..."
    cat > .env.local << EOL
# Convex Configuration
NEXT_PUBLIC_CONVEX_URL=

# Application Configuration  
NEXT_PUBLIC_APP_URL=http://localhost:3000
NODE_ENV=development

# TreeShop AI Configuration
NEXT_PUBLIC_APP_NAME="TreeShop AI"
NEXT_PUBLIC_COMPANY_NAME="TreeShop Operations"
EOL
    print_warning "Please configure your NEXT_PUBLIC_CONVEX_URL in .env.local"
fi

# Type checking
print_status "Running TypeScript type checking..."
if npm run type-check; then
    print_success "TypeScript type checking passed"
else
    print_error "TypeScript type checking failed"
    exit 1
fi

# Linting
print_status "Running ESLint..."
if npm run lint; then
    print_success "ESLint passed"
else
    print_warning "ESLint found issues, but continuing..."
fi

# Build the application
print_status "Building Next.js application..."
if npm run build; then
    print_success "Next.js build completed"
else
    print_error "Next.js build failed"
    exit 1
fi

# Check PWA files
print_status "Checking PWA files..."
if [ -f "public/manifest.json" ]; then
    print_success "PWA manifest found"
else
    print_warning "PWA manifest missing"
fi

if [ -f "public/sw.js" ]; then
    print_success "Service worker generated"
else
    print_warning "Service worker not found - this is normal for development builds"
fi

# Display build summary
echo ""
echo "============================================"
echo -e "${GREEN}🎉 TreeAI Build Completed Successfully!${NC}"
echo "============================================"
echo ""
echo -e "${BLUE}📊 Build Summary:${NC}"
echo "• Next.js PWA build: ✅ Complete"
echo "• TypeScript checking: ✅ Passed"
echo "• ESLint validation: ✅ Checked"
echo "• PWA manifest: ✅ Ready"
echo ""
echo -e "${BLUE}🚀 Next Steps:${NC}"
echo "• Local testing: npm run start"
echo "• Development: npm run dev"
echo "• Convex dev: npm run convex:dev"
echo ""
echo -e "${YELLOW}⚠️  Remember to:${NC}"
echo "• Configure your Convex URL in .env.local"
echo "• Test all TreeScore calculations"
echo "• Verify PWA installation prompts"
echo "• Check mobile responsiveness"
echo ""
echo -e "${GREEN}Ready for Vercel deployment! 🌳${NC}"